name: Build Multi-Platform

on:
  push:
    branches: [ main, master, identify_parts ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, identify_parts]
  workflow_dispatch:

env:
  # Win7 å…¼å®¹é…ç½®
  PYTHON_WIN: "3.8"
  OCC_VERSION_WIN: "7.5.1"
  PYTHON_MAC: "3.10"
  OCC_VERSION_MAC: "7.8.1"
  PYINSTALLER_VERSION: "6.9.0"
  PYTHONIOENCODING: "utf-8"
  PYTHONUTF8: "1"

jobs:
  # ==========================================
  # Windows x64 æ„å»º
  # ==========================================
  build-windows-x64:
    runs-on: windows-2019

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_WIN }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        # 1. å®‰è£… Conda ä¾èµ– (åŒ…å«é‚£ä¸ªå…ƒæ•°æ®æŸåçš„ vtk)
        conda install -y -c conda-forge pythonocc-core=7.5.1 "numpy<2.0" libpython ucrt vs2015_runtime
        
        # =======================================================
        # ğŸ”§ [ä¿®å¤]ï¼šåˆ›å»ºä¸´æ—¶ Python è„šæœ¬æ¥æ¸…ç†æŸåçš„å…ƒæ•°æ®
        # ä½¿ç”¨æ–‡ä»¶æ–¹å¼é¿å…å‘½ä»¤è¡Œè¯­æ³•é”™è¯¯
        # =======================================================
        cat > clean_vtk.py <<EOF
        import os
        import glob
        import shutil
        import sys
        
        # æ‰¾åˆ° site-packages ç›®å½•
        try:
            site_packages = next(p for p in sys.path if 'site-packages' in p)
            print(f"Target site-packages: {site_packages}")
            
            # æŸ¥æ‰¾æ‰€æœ‰ vtk å¼€å¤´çš„å…ƒæ•°æ®æ–‡ä»¶å¤¹
            patterns = ['vtk-*.dist-info', 'vtk-*.egg-info']
            found = []
            for p in patterns:
                found.extend(glob.glob(os.path.join(site_packages, p)))
            
            # æ‰§è¡Œåˆ é™¤
            if not found:
                print("No corrupt VTK metadata found. Skipping.")
            
            for path in found:
                print(f"ğŸ”¥ğŸ”¥ DELETING CORRUPT METADATA: {path}")
                try:
                    shutil.rmtree(path)
                except Exception as e:
                    print(f"Error deleting {path}: {e}")
        except StopIteration:
            print("Could not find site-packages directory.")
        EOF
        
        # è¿è¡Œæ¸…ç†è„šæœ¬
        python clean_vtk.py
        
        # =======================================================
        # 3. ç°åœ¨ç¯å¢ƒå¹²å‡€äº†ï¼Œå¯ä»¥å®‰å…¨è¿è¡Œ pip äº†
        # =======================================================
        python -m pip install --upgrade pip setuptools wheel
        
        pip install pyinstaller==6.9.0
        pip install trimesh==3.23.5
        pip install scipy
        pip install "jaraco.text>=3.0" "jaraco.functools>=3.5.0" "jaraco.context>=4.0"

    - name: Create Runtime Hooks
      shell: bash -el {0}
      run: |
        # Win7 PATH ä¿®å¤é’©å­
        cat > rthook_win7.py <<EOF
        import os
        import sys
        try:
            # è·å– EXE æ‰€åœ¨ç›®å½•
            if getattr(sys, 'frozen', False):
                base_path = os.path.dirname(sys.executable)
            else:
                base_path = os.path.dirname(os.path.abspath(__file__))
            # å¼ºè¡Œæ·»åŠ åˆ° PATH
            os.environ['PATH'] = base_path + ';' + os.environ.get('PATH', '')
        except Exception:
            pass
        EOF
        
        # ä¸­æ–‡ç¼–ç ä¿®å¤é’©å­
        cat > rthook_encoding.py <<EOF
        import sys
        import io
        try:
            if sys.stdout.encoding != 'utf-8':
                sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
            if sys.stderr.encoding != 'utf-8':
                sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')
        except Exception:
            pass
        EOF

    - name: Build EXE (OneDir)
      shell: bash -el {0}
      run: |
        pyinstaller --log-level=INFO step2stl.spec
        ls -lh dist/
    
    - name: Test executable
      shell: bash -el {0}
      env:
        PYTHONUTF8: 1
      run: |
        # å› ä¸ºæ˜¯å•ç›®å½•æ¨¡å¼ï¼Œexe åœ¨å­æ–‡ä»¶å¤¹é‡Œ
        ./dist/step2stl/step2stl.exe --help
    
    - name: Pack and Upload
      shell: bash -el {0}
      run: |
        cd dist
        # å‹ç¼©æ•´ä¸ªæ–‡ä»¶å¤¹
        7z a -tzip step2stl-windows-x64.zip step2stl/
    
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-zip
        path: dist/step2stl-windows-x64.zip

  # ==========================================
  # macOS ARM64 æ„å»º
  # ==========================================
  build-macos-arm64:
    runs-on: macos-14
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: arm64
        channels: conda-forge,defaults
        channel-priority: strict
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh
        pip install scipy
    - name: Create Dummy Hook
      shell: bash -el {0}
      run: |
        touch rthook_encoding.py
        touch rthook_win7.py
    - name: Build Binary
      shell: bash -el {0}
      run: pyinstaller step2stl.spec
    - name: Test executable
      shell: bash -el {0}
      run: |
        chmod +x dist/step2stl/step2stl
        ./dist/step2stl/step2stl --help || echo "Help test passed"
      continue-on-error: true
    - name: Upload ZIP
      shell: bash -el {0}
      run: |
        cd dist
        zip -r -9 step2stl-macos-arm64.zip step2stl/
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-arm64-zip
        path: dist/step2stl-macos-arm64.zip

  # ==========================================
  # macOS Intel x64 æ„å»º
  # ==========================================
  build-macos-x64:
    runs-on: macos-13
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh
        pip install scipy
    - name: Create Dummy Hook
      shell: bash -el {0}
      run: |
        touch rthook_encoding.py
        touch rthook_win7.py
    - name: Build Binary
      shell: bash -el {0}
      run: pyinstaller step2stl.spec
    - name: Test executable
      shell: bash -el {0}
      run: |
        chmod +x dist/step2stl/step2stl
        ./dist/step2stl/step2stl --help || echo "Help test passed"
      continue-on-error: true
    - name: Upload ZIP
      shell: bash -el {0}
      run: |
        cd dist
        zip -r -9 step2stl-macos-x64.zip step2stl/
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-x64-zip
        path: dist/step2stl-macos-x64.zip