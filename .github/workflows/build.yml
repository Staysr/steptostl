name: Build Multi-Platform

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_WIN: "3.9"
  PYTHON_MAC: "3.10"
  OCC_VERSION_WIN: "7.8.1"
  OCC_VERSION_MAC: "7.8.1"
  PYINSTALLER_VERSION: "6.9.0"

jobs:
  # ==========================================
  # Windows x64 ÊûÑÂª∫
  # ==========================================
  build-windows-x64:
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_WIN }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        echo "üîß Installing pythonocc-core..."
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_WIN }}
        
        echo "üîß Installing Python packages..."
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh==3.23.5
        
        # üîß ÂÖ≥ÈîÆÔºöÂÆâË£ÖÂÖºÂÆπÁâàÊú¨ÁöÑ numpy
        echo "üîß Installing numpy (compatible version)..."
        pip install "numpy>=1.21.0,<2.0" --force-reinstall
        
        # üîß ÂÖ≥ÈîÆÔºöÂÆâË£Ö jaraco ‰æùËµñ
        echo "üîß Installing jaraco dependencies..."
        pip install "jaraco.text>=3.0" "jaraco.functools>=3.5.0" "jaraco.context>=4.0"
        
        echo "‚úÖ Installation complete!"
    
    - name: Verify installations
      shell: bash -el {0}
      run: |
        echo "=" | tr '=' '-' | head -c 60 && echo
        echo "System Information"
        echo "=" | tr '=' '-' | head -c 60 && echo
        
        echo "Python version:"
        python --version
        
        echo -e "\nPython location:"
        which python
        
        echo -e "\n=" | tr '=' '-' | head -c 60 && echo
        echo "Package Versions"
        echo "=" | tr '=' '-' | head -c 60 && echo
        
        python -c "import numpy; print(f'numpy: {numpy.__version__}')"
        python -c "import trimesh; print(f'trimesh: {trimesh.__version__}')"
        python -c "import OCC; print(f'OCC VERSION: {OCC.VERSION}')"
        
        echo -e "\n=" | tr '=' '-' | head -c 60 && echo
        echo "Module Import Tests"
        echo "=" | tr '=' '-' | head -c 60 && echo
        
        python -c "from OCC.Core.STEPControl import STEPControl_Reader; print('‚úì OCC.Core.STEPControl')"
        python -c "import trimesh; print('‚úì trimesh')"
        python -c "import numpy; print('‚úì numpy')"
        python -c "import numpy._core._multiarray_tests; print('‚úì numpy._core._multiarray_tests')"
        python -c "import jaraco.text; print('‚úì jaraco.text')"
        python -c "import ipaddress; print('‚úì ipaddress')"
        python -c "import urllib.parse; print('‚úì urllib.parse')"
        
        echo -e "\n‚úÖ All verifications passed!"
    
    - name: Build EXE
      shell: bash -el {0}
      run: |
        echo "=" | tr '=' '-' | head -c 60 && echo
        echo "üöÄ Starting PyInstaller Build"
        echo "=" | tr '=' '-' | head -c 60 && echo
        
        echo "Cleaning previous builds..."
        rm -rf build dist
        
        echo -e "\nRunning PyInstaller..."
        pyinstaller step2stl.spec
        
        echo -e "\n=" | tr '=' '-' | head -c 60 && echo
        echo "‚úÖ Build Complete!"
        echo "=" | tr '=' '-' | head -c 60 && echo
        
        echo "Output files:"
        ls -lh dist/
        
        if [ -f "dist/step2stl.exe" ]; then
          echo -e "\n‚úÖ step2stl.exe created successfully"
          echo "Size: $(du -h dist/step2stl.exe | cut -f1)"
        else
          echo -e "\n‚ùå ERROR: step2stl.exe not found!"
          exit 1
        fi
    
    - name: Create ZIP package
      shell: bash -el {0}
      run: |
        cd dist
        echo "Creating ZIP archive..."
        7z a -tzip step2stl-windows-x64.zip step2stl.exe
        
        echo "Archive created:"
        ls -lh step2stl-windows-x64.zip
    
    - name: Test executable
      shell: bash -el {0}
      run: |
        echo "=" | tr '=' '-' | head -c 60 && echo
        echo "üß™ Testing Executable"
        echo "=" | tr '=' '-' | head -c 60 && echo
        
        echo "Test 1: --help"
        ./dist/step2stl.exe --help || echo "Help test completed with code $?"
        
        echo -e "\nTest 2: --version (if implemented)"
        ./dist/step2stl.exe --version || echo "Version test completed with code $?"
        
        echo -e "\n‚úÖ Tests completed!"
      continue-on-error: true
    
    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-exe
        path: dist/step2stl.exe
        retention-days: 30
    
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-zip
        path: dist/step2stl-windows-x64.zip
        retention-days: 30

  # ==========================================
  # macOS ARM64 (M1/M2) ÊûÑÂª∫
  # ==========================================
  build-macos-arm64:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: arm64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        echo "üîß Installing pythonocc-core..."
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        
        echo "üîß Installing Python packages..."
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh numpy
        
        echo "‚úÖ Installation complete!"
    
    - name: Verify installations
      shell: bash -el {0}
      run: |
        echo "System info:"
        uname -m
        sw_vers
        
        echo -e "\nPython version:"
        python --version
        
        echo -e "\nChecking imports..."
        python -c "from OCC.Core.STEPControl import STEPControl_Reader; print('‚úì OCC import OK')"
        python -c "import trimesh; print('‚úì trimesh import OK')"
        python -c "import numpy; print('‚úì numpy import OK')"
        
        echo -e "\nOCC version:"
        python -c "import OCC; print('OCC VERSION:', OCC.VERSION)"
    
    - name: Build Binary
      shell: bash -el {0}
      run: |
        echo "üöÄ Starting PyInstaller build..."
        pyinstaller step2stl.spec
        
        echo -e "\n‚úÖ Build complete!"
        ls -lh dist/
        
        echo -e "\nBinary architecture:"
        file dist/step2stl
    
    - name: Create ZIP package
      shell: bash -el {0}
      run: |
        cd dist
        ls -lh step2stl
        zip -9 step2stl-macos-arm64.zip step2stl
        ls -lh step2stl-macos-arm64.zip
    
    - name: Test executable
      shell: bash -el {0}
      run: |
        echo "üß™ Testing executable..."
        chmod +x dist/step2stl
        ./dist/step2stl --help || echo "Help test completed"
      continue-on-error: true
    
    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-arm64-bin
        path: dist/step2stl
        retention-days: 30
    
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-arm64-zip
        path: dist/step2stl-macos-arm64.zip
        retention-days: 30

  # ==========================================
  # macOS Intel x64 ÊûÑÂª∫
  # ==========================================
  build-macos-x64:
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh numpy
    
    - name: Verify installations
      shell: bash -el {0}
      run: |
        uname -m
        python -c "from OCC.Core.STEPControl import STEPControl_Reader; print('OCC import OK')"
        python -c "import OCC; print('OCC VERSION:', OCC.VERSION)"
    
    - name: Build Binary
      shell: bash -el {0}
      run: |
        pyinstaller step2stl.spec
        ls -lh dist/
        file dist/step2stl
    
    - name: Create ZIP package
      shell: bash -el {0}
      run: |
        cd dist
        zip -9 step2stl-macos-x64.zip step2stl
        ls -lh
    
    - name: Test executable
      shell: bash -el {0}
      run: |
        chmod +x dist/step2stl
        ./dist/step2stl --help || echo "Help test completed"
      continue-on-error: true
    
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-x64-zip
        path: dist/step2stl-macos-x64.zip
        retention-days: 30