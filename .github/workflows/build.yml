name: Build Multi-Platform

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†
  PYTHON_WIN: "3.8"
  PYTHON_MAC: "3.10"
  OCC_VERSION_WIN: "7.7.2"
  OCC_VERSION_MAC: "7.8.1"

jobs:
  # ==========================================
  # Windows 7 x64 æž„å»º
  # ==========================================
  build-windows-x64:
    runs-on: windows-2019
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_WIN }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: ðŸ“¦ Install dependencies
      shell: bash -el {0}
      run: |
        echo "ðŸ”§ Installing pythonocc-core..."
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_WIN }}
        
        echo "ðŸ”§ Installing Python packages..."
        pip install pyinstaller==5.13.2
        pip install trimesh==3.23.5
        pip install numpy
    
    - name: ðŸ” Verify installations
      shell: bash -el {0}
      run: |
        echo "ðŸ“‹ Python version:"
        python --version
        
        echo "ðŸ“‹ Checking imports..."
        python -c "from OCC.Core.STEPControl import STEPControl_Reader; print('âœ… OCC OK')"
        python -c "import trimesh; print('âœ… trimesh OK')"
        python -c "import numpy; print('âœ… numpy OK')"
        
        echo "ðŸ“‹ OCC version:"
        python -c "import OCC; print(f'OCC VERSION: {OCC.VERSION}')"
    
    - name: ðŸ”¨ Build EXE
      shell: bash -el {0}
      run: |
        echo "ðŸš€ Starting PyInstaller build..."
        pyinstaller step2stl.spec
        
        echo "ðŸ“Š Build complete!"
        ls -lh dist/
    
    - name: ðŸ“¦ Create ZIP package
      shell: bash -el {0}
      run: |
        cd dist
        # èŽ·å–æ–‡ä»¶å¤§å°
        SIZE=$(ls -lh step2stl.exe | awk '{print $5}')
        echo "ðŸ“Š EXE size: $SIZE"
        
        # åˆ›å»º ZIPï¼ˆWindows åˆ†å‘æŽ¨èï¼‰
        7z a -tzip step2stl-windows-x64.zip step2stl.exe
        
        ZIP_SIZE=$(ls -lh step2stl-windows-x64.zip | awk '{print $5}')
        echo "ðŸ“Š ZIP size: $ZIP_SIZE"
    
    - name: ðŸ§ª Test executable
      shell: bash -el {0}
      run: |
        echo "ðŸ§ª Testing --help..."
        ./dist/step2stl.exe --help
      continue-on-error: true
    
    - name: ðŸ“¤ Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-exe
        path: dist/step2stl.exe
        retention-days: 30
    
    - name: ðŸ“¤ Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-zip
        path: dist/step2stl-windows-x64.zip
        retention-days: 30

  # ==========================================
  # macOS ARM64 (M1/M2) æž„å»º
  # ==========================================
  build-macos-arm64:
    runs-on: macos-14
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: arm64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: ðŸ“¦ Install dependencies
      shell: bash -el {0}
      run: |
        echo "ðŸ”§ Installing pythonocc-core..."
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        
        echo "ðŸ”§ Installing Python packages..."
        pip install pyinstaller
        pip install trimesh
        pip install numpy
    
    - name: ðŸ” Verify installations
      shell: bash -el {0}
      run: |
        echo "ðŸ“‹ System info:"
        uname -m
        sw_vers
        
        echo "ðŸ“‹ Python version:"
        python --version
        
        echo "ðŸ“‹ Checking imports..."
        python -c "from OCC.Core.STEPControl import STEPControl_Reader; print('âœ… OCC OK')"
        python -c "import trimesh; print('âœ… trimesh OK')"
        python -c "import numpy; print('âœ… numpy OK')"
        
        echo "ðŸ“‹ OCC version:"
        python -c "import OCC; print(f'OCC VERSION: {OCC.VERSION}')"
    
    - name: ðŸ”¨ Build Binary
      shell: bash -el {0}
      run: |
        echo "ðŸš€ Starting PyInstaller build..."
        pyinstaller step2stl.spec
        
        echo "ðŸ“Š Build complete!"
        ls -lh dist/
        
        echo "ðŸ“‹ Binary architecture:"
        file dist/step2stl
    
    - name: ðŸ“¦ Create ZIP package
      shell: bash -el {0}
      run: |
        cd dist
        SIZE=$(ls -lh step2stl | awk '{print $5}')
        echo "ðŸ“Š Binary size: $SIZE"
        
        # åˆ›å»º ZIP
        zip -9 step2stl-macos-arm64.zip step2stl
        
        ZIP_SIZE=$(ls -lh step2stl-macos-arm64.zip | awk '{print $5}')
        echo "ðŸ“Š ZIP size: $ZIP_SIZE"
    
    - name: ðŸ§ª Test executable
      shell: bash -el {0}
      run: |
        echo "ðŸ§ª Testing --help..."
        chmod +x dist/step2stl
        ./dist/step2stl --help
      continue-on-error: true
    
    - name: ðŸ“¤ Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-arm64-bin
        path: dist/step2stl
        retention-days: 30
    
    - name: ðŸ“¤ Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-arm64-zip
        path: dist/step2stl-macos-arm64.zip
        retention-days: 30

  # ==========================================
  # macOS Intel x64 æž„å»ºï¼ˆå¯é€‰ï¼‰
  # ==========================================
  build-macos-x64:
    runs-on: macos-13
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: ðŸ“¦ Install dependencies
      shell: bash -el {0}
      run: |
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        pip install pyinstaller trimesh numpy
    
    - name: ðŸ” Verify installations
      shell: bash -el {0}
      run: |
        uname -m
        python -c "from OCC.Core.STEPControl import STEPControl_Reader; print('âœ… OCC OK')"
        python -c "import OCC; print(f'OCC VERSION: {OCC.VERSION}')"
    
    - name: ðŸ”¨ Build Binary
      shell: bash -el {0}
      run: |
        pyinstaller step2stl.spec
        ls -lh dist/
        file dist/step2stl
    
    - name: ðŸ“¦ Create ZIP package
      shell: bash -el {0}
      run: |
        cd dist
        zip -9 step2stl-macos-x64.zip step2stl
        ls -lh
    
    - name: ðŸ§ª Test executable
      shell: bash -el {0}
      run: |
        chmod +x dist/step2stl
        ./dist/step2stl --help
      continue-on-error: true
    
    - name: ðŸ“¤ Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-x64-zip
        path: dist/step2stl-macos-x64.zip
        retention-days: 30

  # ==========================================
  # æž„å»ºæ‘˜è¦
  # ==========================================
  summary:
    needs: [build-windows-x64, build-macos-arm64, build-macos-x64]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Build Summary
      run: |
        echo "# ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows x64 | ${{ needs.build-windows-x64.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS ARM64 | ${{ needs.build-macos-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS x64 | ${{ needs.build-macos-x64.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ **Downloads available in Artifacts**" >> $GITHUB_STEP_SUMMARY