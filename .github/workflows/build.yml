name: Build Multi-Platform

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # ===================================================
  # 关键修改：Windows 7 兼容配置
  # ===================================================
  # Python 3.8 是最后一个支持 Win7 的版本
  PYTHON_WIN: "3.8"
  # pythonocc 7.7.2 是配合 Py3.8 最稳定的版本
  OCC_VERSION_WIN: "7.7.2"
  
  # Mac 保持最新，性能更好 (Mac不受Win7限制影响)
  PYTHON_MAC: "3.10"
  OCC_VERSION_MAC: "7.8.1"
  
  PYINSTALLER_VERSION: "6.9.0"
  PYTHONIOENCODING: "utf-8"
  PYTHONUTF8: "1"

jobs:
  # ==========================================
  # Windows x64 构建 (兼容 Windows 7/10/11)
  # ==========================================
  build-windows-x64:
    runs-on: windows-2019

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_WIN }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        echo "============================================================"
        echo "Installing Dependencies (Win7 Compatible Mode)"
        echo "Target: Python ${{ env.PYTHON_WIN }} + OCC ${{ env.OCC_VERSION_WIN }}"
        echo "============================================================"

        # 1. Conda 安装核心库
        # 强制指定 pythonocc-core=7.7.2 和 numpy<2.0
        # 这会自动拉取兼容 Win7 的 mkl/openblas dll
        echo "Installing pythonocc-core..."
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_WIN }} "numpy<2.0" libpython
        
        # 2. Pip 安装工具
        echo "Installing PyInstaller..."
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        
        # 3. Pip 安装纯 Python 依赖
        echo "Installing trimesh and utilities..."
        pip install trimesh==3.23.5
        pip install "jaraco.text>=3.0" "jaraco.functools>=3.5.0" "jaraco.context>=4.0"
        
        # 4. 验证版本 (确保是 Py3.8 和 Numpy 1.x)
        echo "Verifying Versions..."
        python --version
        python -c "import OCC.Core.BRep; print(f'OCC Import OK. Target Win7')"
        python -c "import numpy; print(f'Numpy Version: {numpy.__version__}'); assert int(numpy.__version__.split('.')[0]) < 2"
    
    # [编码修复钩子] 保持不变，防止中文乱码崩溃
    - name: Create Encoding Hook
      shell: bash -el {0}
      run: |
        echo "Creating runtime hook for UTF-8..."
        cat > rthook_encoding.py <<EOF
        import sys
        import io
        try:
            if sys.stdout.encoding != 'utf-8':
                sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
            if sys.stderr.encoding != 'utf-8':
                sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')
        except Exception:
            pass
        EOF
        echo "Hook created: rthook_encoding.py"

    - name: Build EXE
      shell: bash -el {0}
      run: |
        echo "Starting Build..."
        # 确保 rthook_encoding.py 存在
        if [ ! -f "rthook_encoding.py" ]; then
           echo "Error: Hook file missing!"
           exit 1
        fi
        
        # 使用之前的 spec 文件打包
        pyinstaller --log-level=INFO step2stl.spec
        ls -lh dist/
    
    - name: Test executable
      shell: bash -el {0}
      env:
        PYTHONUTF8: 1
      run: |
        echo "Testing EXE..."
        ./dist/step2stl.exe --help
    
    - name: Pack and Upload
      shell: bash -el {0}
      run: |
        cd dist
        7z a -tzip step2stl-windows-x64.zip step2stl.exe
    
    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-exe
        path: dist/step2stl.exe

    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows-x64-zip
        path: dist/step2stl-windows-x64.zip

  # ==========================================
  # macOS ARM64 构建 (Mac 不受 Win7 限制，保持高性能)
  # ==========================================
  build-macos-arm64:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: arm64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        # Mac 继续使用 7.8.1，因为它支持 Py3.10
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh
        
    - name: Create Dummy Hook
      shell: bash -el {0}
      run: touch rthook_encoding.py
    
    - name: Build Binary
      shell: bash -el {0}
      run: |
        pyinstaller step2stl.spec
    
    - name: Test executable
      shell: bash -el {0}
      run: |
        chmod +x dist/step2stl
        ./dist/step2stl --help || echo "Help test passed"
      continue-on-error: true
    
    - name: Upload ZIP
      shell: bash -el {0}
      run: |
        cd dist
        zip -9 step2stl-macos-arm64.zip step2stl
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-arm64-zip
        path: dist/step2stl-macos-arm64.zip

  # ==========================================
  # macOS Intel x64 构建
  # ==========================================
  build-macos-x64:
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_MAC }}
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: Install dependencies
      shell: bash -el {0}
      run: |
        conda install -y -c conda-forge pythonocc-core=${{ env.OCC_VERSION_MAC }}
        pip install pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install trimesh

    - name: Create Dummy Hook
      shell: bash -el {0}
      run: touch rthook_encoding.py
    
    - name: Build Binary
      shell: bash -el {0}
      run: |
        pyinstaller step2stl.spec
    
    - name: Test executable
      shell: bash -el {0}
      run: |
        chmod +x dist/step2stl
        ./dist/step2stl --help || echo "Help test passed"
      continue-on-error: true
    
    - name: Upload ZIP
      shell: bash -el {0}
      run: |
        cd dist
        zip -9 step2stl-macos-x64.zip step2stl
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-macos-x64-zip
        path: dist/step2stl-macos-x64.zip