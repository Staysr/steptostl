name: Build Windows 7 EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows-x64:
    runs-on: windows-2019
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Miniconda (x64)
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.8
        architecture: x64
        channels: conda-forge,defaults
        channel-priority: strict
    
    - name: ğŸ“¦ Install dependencies via Conda
      shell: bash -el {0}
      run: |
        conda install -y -c conda-forge pythonocc-core=7.7.2
        pip install pyinstaller==5.13.2
        pip install trimesh==3.23.5
    
    - name: ğŸ” Check installations
      shell: bash -el {0}
      run: |
        python -c "import OCC.Core.STEPControl; print('âœ… OCC import OK')"
        python -c "import trimesh; print('âœ… trimesh import OK')"
        python -c "import numpy; print('âœ… numpy import OK')"
      continue-on-error: true
    
    - name: ğŸ”¨ Build EXE with PyInstaller
      shell: bash -el {0}
      run: |
        pyinstaller step2stl.spec
    
    - name: ğŸ“‹ Show build info
      shell: bash -el {0}
      run: |
        ls -lh dist/
        echo "Testing executable..."
        ./dist/step2stl.exe --help || true
      continue-on-error: true
    
    - name: ğŸ“¤ Upload Windows x64 EXE
      uses: actions/upload-artifact@v4
      with:
        name: step2stl-windows7-x64
        path: dist/step2stl.exe
        retention-days: 30